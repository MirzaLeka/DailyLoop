<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
     <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>    
  <!-- Font awesome -->
  <script src="https://use.fontawesome.com/fe459689b4.js"></script>
</head>
<body>

    <h1 style="width: 100%; margin: 0 auto; text-align: center;">Todo App WIP</h1>

        <div class="container">
                <div class="jumbotron" style="background: white">
                  <div class="row">
                    <div class="col-xs-12">

    <div id="insertTodo" style="width: 100%">
            Insert Todo
            <input class="form-control" type="text" id="text"/> <br>
            <button class="btn btn-success" style="margin: 0 auto; text-align: center;" onclick="submit()">Submit Todo</button>
            
    </div>

    <h2 id="id">Todos:</h2> 
    <br>

    <div id="main"></div>

    <br> <br>

    <button class="btn btn-danger" onclick="deleteAllTodos()">DELETE ALL</button>

    <br> <br>

    Update
    <input class="form-control" style="width: 250px" type="text" id="updateTodo"/> <br>
    <button class="btn btn-success" onclick="updateTodo()">Update Todo</button>

                    </div>
                  </div>
                </div>
        </div>
    
</body>
<style>

body{
    margin: 40px;
}

.todoContainer{
    border: 1px solid #111;
    background: #f5f5f5;
    border-top: none;
}

.todoContainer:first-child {
    border-top: 1px solid black;
}

</style>


<script>



   $(document).ready(function() {

       getTodos()

});


  
function getTodos() {
   
 
$.ajax({
    type: "GET",
    url: "/todos",
    success: function(data) {

console.log(data);  

var list = '';


for (var i = 0; i < data.todos.length; i++) {

let status = '';
let finished = '';


var id = data.todos[i]._id.toString();

console.log(i  + " " + typeof id); // outputs String
console.log(id);

if (data.todos[i].completed) {
    status = "Completed";
    finished = "Completed At: " + data.todos[i].completedAt;
}
else {
    status = "Not completed";
}

list += `<div class="container todoContainer">
       
        <div class="row">

         <div class="col-sm-9">
    <h3 class="title">${data.todos[i].text}</h3>
           </div>
   <div class="col-sm-1">
    <button class="btn btn-primary" title="Complete" style="border-radius: 100%; margin-top: 12px;" onclick="updateTodo(${id})"><i class="fa fa-pencil" aria-hidden="true"></i></button>
    </div>
    <div class="col-sm-1">
            <div class="btn btn-success" style="border-radius: 100%; margin-top: 12px;" onclick='completeTodo(${data.todos[i].completed}, ${id})'><i class="fa fa-check" aria-hidden="true"></i></div>    
     </div>        
   <div class="col-sm-1">
      <button class="btn btn-danger" title="Remove" style="border-radius: 100%; margin-top: 12px;" onclick="getTitle(${i})"><i class="fa fa-times" aria-hidden="true"></i></button>
            </div>

         </div>

         <div class="row">
         
         <div class="col-sm-4"><p class="status">Status: ${status}</p></div>
         <div class="col-sm-4"> <p class="finished">${finished}</p> </div>
         <div class="col-sm-4"> </div>

          </div>

    </div>`;
}

document.getElementById("main").innerHTML = list;

    }

});

}






    $("#text").keyup(function(event){
  if(event.keyCode == 13){
    submit();
  }
});




    // var complete = false;

function submit() {

    var text = $("#text").val();

    text =  adjustString(text);


//     var completed = $("#completed").val();

// console.log("Completed value is " + completed);

//     var completedAt = $("#completedAt").val();

    // if (completed == ' ') {
    //     complete = true;
    // }  else {
    //     complete == true;
    // }

 //   console.log("Complete is " + complete + ", completedAt is" + completedAt);

var data = {
    "text": text
}

//console.log("DAta is " + JSON.stringify(data));

$.ajax({
    type: "POST",
    url: "/todos",
    contentType : 'application/json',
    dataType : 'json',
    data : JSON.stringify(data),
    success: function(data) {
    
    location.reload(); // reloads page
    }

});


}

function search() {

    console.log("I'm inside");

var search = $("#search").val();

console.log("Value of search is " + search);

$.ajax({
    type: "GET",
    url: "/todos/5b609055aedeae23fcfa9ddd/",
    contentType : 'application/json',
    dataType : 'json',
    sucess: function(data) {
       var myData = JSON.parse(data.responseText);
       
        console.log("succeeded");
        console.log(myData);
    }
});

}

function getTitle(counter) {

    console.log("Counter: " + counter)

// var todoTitle =  $("h2").html();

var todoTitle =  $(`.todoContainer:eq(${counter})`).find(`.title`).html();

// alert(todoTitle);

    $.ajax({
    url: '/todos/' + todoTitle,
    type: 'DELETE',
    success: function(result) {
    location.reload();
    }
});


}

function deleteTodo() {

    var deleteText = $("#deleteText").val();
 //   console.log("1: "+ deleteText);

    deleteText = adjustString(deleteText);

    $.ajax({
    url: '/todos/' + deleteText,
    type: 'DELETE',
    success: function(result) {
     console.log("Deleted: \n" + JSON.stringify(result));
    location.reload();
    }
});
}

function deleteAllTodos() {

    $.ajax({
    url: '/todos',
    type: 'DELETE',
    success: function() {
        location.reload();
    }


});

}


function adjustString(str) {

    str = str.trim();

    str = str.toLowerCase();

    str = str.charAt(0).toUpperCase() + str.substr(1,str.length).toLowerCase();

    return str;
}


function completeTodo(isCompleted, someId) {

    console.log("ID: " + someId);

    if (isCompleted) {
        isCompleted = false;
    } else {
        isCompleted = true;
    }

var data = {
    completed: isCompleted
};


$.ajax({
url: "/todos/" + someId,
data: JSON.stringify(data),
type: 'PATCH',
contentType: 'application/json',
processData: false,
dataType: 'json',
success: function (data) {
location.reload();
}


});

}

function updateTodo(id) {

var updateTodo = $("#updateTodo").val();
//var updateCompleted = $("#updateCompleted").val();

var data = {
    text: updateTodo
};

// 5b6373e3dad6f310dc087cf0

$.ajax({
url: "/todos/" + id,
data: JSON.stringify(data),
type: 'PATCH',
contentType: 'application/json',
processData: false,
dataType: 'json',
success: function (data) {
location.reload();
}


});

}



</script>

</html>